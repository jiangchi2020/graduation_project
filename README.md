# 毕业设计-高铁沿线旅游信息自然语言查询系统设计与实现


## 任务概述

### 数据-->PostgreSQL+PostGIS √
1. POI数据：旅游景点，酒店，餐饮。
2. 车站属性数据：车站名称，经纬度，与线路的关系，可从列车时刻表爬取，并利用地址编码服务获取经纬度。
3. 背景网络地图：高德，Google等。
4. 铁路线路分布：从OSM（Open Street Map）获取（ShapeFile格式）整理入库。

### 自然语言查询（可参考智能问答系统）
1. 分词-->提取关键词
2. 分类算法（机器学习）-->可参考朴素贝叶斯分类算法，可使用sk-learn实现
3. SQL模板中的参数值获取，分词-->词性/句子成分

### Web可视化
1. 自然语言查询交互 √
2. 自然语言查询可视化 √
3. POI点属性查询：描述文本/图片等 √
4. POI属性维护界面（管理员界面）
5. 路径分析（可选）

## 工程描述

### package
所有java代码以```com.scarike.gp```开头（gp即graduation_project）

### module
|模组|子包名|描述|类型|创建时间|
|:---:|:---:|:---|:---|:---|
|gp-crawler|```crawler```|maven|爬虫|2022-01-02|
|gp-vue|```-```|vue-cli|[项目前端模块](gp-vue/README.md)|2022-01-12|
|gp-web|```web```|maven|[JavaWeb后端父工程](gp-web/README.md)|2022-03-13|

#### gp-web子模块
|模组|子包名|端口|描述|类型|创建时间|
|:---:|:---:|:---:|:---|:---|:---|
|common|```common```|-|maven|通用模块|2022-03-13|
|common-spring-boot-starter|```common.starter```|-|spring boot starter|通用SpringBoot自动配置|2022-03-13|
|nlp-interface|```grpc```|-|maven|NLP服务gRPC接口|2022-03-13|
|gateway|```gateway```|7070+|Spring Cloud Gateway|限流网关|2022-03-16|
|poi|```poi```|8080+|Spring Boot|POI服务|2022-03-13|
|sentinel dashboard|```-```|9090+|Sentinel Dashboard|Sentinel控制台|2022-03-16|
|nacos|```-```|8848,9848,9849|nacos注册中心|nacos|2022-03-16|


## 更新日志

### 2022-01-06
完成12306的爬虫部分。主要利用到12306官网上的两个API，一个根据关键词模糊查询车次号，由于中国的车次都包含数字，部分不包含字母，
故使用关键字0-9然后去重可以查询到所有的车次。
另一个根据车次号，可以查询该车次的经停站，这里就之关心车站名和到达时间/出发时间，将车站名去重可以得到所有车站，12306的首页也有一个静态文件保存了所有的车站信息，但是有很多冗余，故舍弃此方法。
第二部分是每一车次都需要进行一次请求，属于IO密集型任务，故使用多线程进行优化，在本机八核十六线程的CPU上，设置32个线程并发请求实测可以将2分多钟的时间缩短到6秒以内
第一部分只有10个请求故使用多线程意义不大

第二步是给车站赋唯一id，这里使用一个hashmap保存车站名和id，在遍历经停站信息时，如果发现map中没有此车站名，就赋值id（同时id自增）然后将车站名保存到hashmap（此时完成去重操作）
需要车站名到车站id的操作都可以使用该hashmap作为映射

第三步是构造SQL语句然后写入到数据库。暂时保存在MySQL数据库中，日后迁移并不是太麻烦
车次信息直接使用车次编号作为主键，车站使用第二步生成的id作为主键

目前该部分还有一定缺陷，中国列车的车次编号，远离北京方向的为奇数，驶向北京方向的为偶数。
但是部分车次是先远离然后自增，这样一辆车次在不同阶段就会有两个车次编号。这个问题在12306官网与APP上都没有得到很好的统一。目前本系统，只是将发车时的编号作为唯一的车次号
根据日后的系统需求，可能需要酌情矫正

### 2022-01-07
使用高德地图提供的地理编码WebAPI，通过车站名可以获取到车站的经纬度坐标信息，不过有部分车站没有获取到，需要手动添加。
顺便记录了一下爬虫的耗时（下面是运行的输出），还有加速的空间，但是继续优化就需要牺牲代码可读性了：
```shell
# 获取车次信息耗时1223ms
# 获取经停站信息耗时7626ms
# 生成唯一id耗时22ms
# 地理编码耗时1369ms
# 生成SQL语句耗时15ms
# 执行SQL耗时1167ms
# 任务耗时11434ms
# end
```
刚刚看了下，貌似毕业设计的需求可以使用高德开放API一站式解决了……

高德开放WebAPI中提供了:

1. 地理编码服务API https://lbs.amap.com/api/webservice/guide/api/georegeo#geo
2. POI关键字查询API https://lbs.amap.com/api/webservice/guide/api/search#text
3. POI范围查询API https://lbs.amap.com/api/webservice/guide/api/search#around

备忘一下高德API中POI的编码

1. 050000 餐饮服务
2. 110000 风景名胜
3. 100000 宾馆酒店

这……这样的话兴趣点查询直接调用API就行了（如果只是为了实现功能的话）

### 2022-01-11

使用高德提供的JS API，初步完成了可视化

备份一下中国shp的下载连接：https://download.geofabrik.de/asia/china-latest-free.shp.zip

### 2022-01-13

将高德提供的卫星地图与从OSM下载的中国铁路shapefile文件可视化，使用geoserver发布WMS服务

### 2022-01-16

这两天通过高德的POI搜索Web API，爬了一下POI数据。
使用两张表，一张存储POI信息，另一张存储照片url，照片和POI是多对一的关系，使用poi_id字段作为连接字段。
poi_id从0自增

酒店(100000)，旅游景点(110000)，餐饮(050000)分别储存在三张表中

今天只爬到了酒店和旅游景点，每日请求数量限制达到64%了，估计餐饮更多，就没敢继续爬取，明天再爬吧。
前面两类的数据量已经达到了20w左右，照片更是达到了50w张
（因为只保存了url，照片实际存储在高德提供的服务器，所以实际不大）
，按照id进行连接查询的话差不多在51ms。
其实爬的信息还是不够全，按照API返回的城市列表进行进一步查询，但是城市列表不全

爬的过程中几个要点的备份：
1. try-with-resources语法糖，try语句块结束之后会自动关闭资源，这本来是废话，但是在try语句块中创建额外线程使用资源的时候应当注意这一点，记得join线程
2. 创建表时同时声明普通索引语法：```[INDEX|UNIQUE|PRIMARY KEY|FULLTEXT](col_name) USING [BTREE|HASH]```，可视化工具用的顺手可不能忘了SQL语句怎么写
3. VsCode的正则表达式匹配替换功能十分强大，可以使用它来批量处理SQL文件中的错误，包括：
   1. 匹配不和,)相邻的'正则：```([^,])'([^,\)])```->```$1\'$2```可以用于处理地名中包含'导致的sql错误
   2. ```[^1][0-9]{5}\||\|[^1][0-9]{5}|[0-9][^0][0-9]{4}\||\|[0-9][^0][0-9]{4}```匹配不以10开头的POI编码及其相邻的一个|，删除之
   3. ```(10[0-9]{4})\|10[0-9]{4}```->```$1```匹配多个以10开头的POI编码，保留第一个，重复若干次
   4. 删除省级市中重复的名称，```(北京市|天津市|上海市|重庆市|香港特别行政区|澳门特别行政区){2}```->```$1```
   5. 删除最后一个分号
   6. 匹配null删除之

### 2022-01-18

爬虫部分有误，全部重新爬...这回使用所有的中国省级市，地级市，自治州，盟，地区共339个，而不是API返回的城市列表。

因为高德WebAPI限制QPS为每秒50，开8个线程以上就拿不到信息进而报空指针异常，无解，只能用八个线程慢慢来了。

### 2022-01-19

总算是爬完了，API访问额度刚刚好，3w个用了29763多个，

|POI CODE|TYPE|NUMBER|PHOTOS NUMBER|
|:---:|:---:|:---:|:---:|
|050000|餐饮|297226|626115|
|100000|酒店|280186|766717|
|110000|风景名胜|208165|217865|

给前端页面加上了搜索框，通过cdn方式手动引入element-ui组件库，修改源代码，只引入icon部分。

现在是23：59，还差一分钟就要另起一天了

### 2022-01-24

国内一般要求地图系统必须要经过一次加密，高德地图使用的就是GCJ02坐标系，与WGS84有一点点偏差

而osm下载的中国铁路数据是标准wgs84坐标系，使用工具转换一下能够完美显示在地图上，天地图是个特例没有使用GCJ02，所以原来的铁路数据和天地图提供的地图没有偏差，所以还是换回高德地图把，高德他每天不限量呀

这两天折腾了一下双系统，只用ubuntu还是不行啊，整一个windows安装arcgis用于处理地理数据

### 2022-02-24

把车站标记显示在地图上

### 2022-02-27

添加了poi列表组件，自定义了一套通知弹窗，虽然UI设计上还是抄的ElementUI

### 2022-03-03

vue前端基本就写成这样了，开学之前还有几天，主要任务侧重于poi数据的整理，还有就是geoserver展示优化。

整了一个下午主要就是搞geoserver去了，官方没有中文文档，本英语菜鸡简直太费力了，国人写的博客等于没有，还不如看英文文档，离谱，CSDN博客园什么的基本全是互相转载，国内IT网站就图一乐，真学习还得看英文。

自从使用了chrome+插件，屏蔽了CSDN之后效率高多了。

今天主要收获就是geoserver的展示样式设置，回头另成文档备忘。

果然geoserver还是很卡么，这才三个图层哎。别说2C4G的服务器了，在我本机8C8G的电脑上也卡的一批（实测在2C4G服务器上CPU直接干到96%了...）

考虑需要部署一下WMTS服务取代WMS了

### 2022-03-11

芜湖，“大成功”，把shp导入到postgis数据库中，这里备份一下命令。
```shell

# sudo apt install gdal-bin; is required for command 'ogr2ogr'

ogr2ogr -nlt PROMOTE_TO_MULTI \
 -f "PostgreSQL" \
  PG:"host=127.0.0.1 dbname=gp user=postgres password=***" \
   /home/ubuntu/geoserver-2.20.1-bin/data_dir/data/cn_rail/cn_railway_gcj02_3857.shp

```

当前任务：
1. 整理车站地理信息，补充null值
2. POI数据转postgis

### 2022-03-12

补充了地理位置为null的车站，共167个
将所有数据迁移到postgresql中并生成空间索引

备忘一下postgis使用

[PostGIS学习手册](postgis-doc.md)

### 2022-03-13

快1点了，大成功，终于基于postgis实现了缓冲区查询

启动项目后端模块开发，终于到了最拿手的JavaWeb阶段，我说个数，下周三之前，写好


### 2022-03-15

更新前端，将vue2的写法改进成vue3的单文件组件写法。

SpringBoot整合Postgresql，实现基于PostGIS的缓冲区查询

整合gRpc实现自然语言处理接口的远程调用

马上就要大功告成力~~~

### 2022-03-19

修改proto接口使得支持多条关键字的查询。

增添基于sentinel的rpc接口限流，增添持久化规则。

所以目前来说，整个项目需要部署的组件有：

1. nginx+静态资源文件
2. postgresql+postgis
3. geoserver
4. sentinel dashboard（需要支持和poi-service双向通信）
5. nacos
6. poi-service
7. gp-gateway
8. nlp-service（python）
